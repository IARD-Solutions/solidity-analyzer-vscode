import * as vscode from 'vscode';
import { Vulnerability } from '../models/types';

/**
 * Processes raw vulnerabilities from the API, extracting line information
 * and filtering according to configuration settings.
 *
 * @param vulnerabilities Raw vulnerabilities from the API
 * @returns Processed vulnerabilities with line information
 */
export function handleVulnerabilities(vulnerabilities: Vulnerability[]): Vulnerability[] {
    const config = vscode.workspace.getConfiguration('solidityAnalyzer');
    const analyzeNodeModules = config.get<boolean>('analyzeNodeModules');

    if (!analyzeNodeModules) {
        vulnerabilities.forEach(vuln => {
            vuln.description = vuln.description
                .split('\n')
                .filter(line => !line.includes('node_modules'))
                .join('\n');
        });
    }

    // Regular expression to extract file and line information from descriptions
    const lineRegex = /([^\s()]+\.sol)#(\d+)(?:-(\d+))?/g;

    return vulnerabilities
        .map(vuln => {
            const lines: { contract: string, lines: number[] }[] = [];
            let match;
            
            while ((match = lineRegex.exec(vuln.description)) !== null) {
                const contract = match[1];
                const startLine = parseInt(match[2], 10);
                const endLine = match[3] ? parseInt(match[3], 10) : startLine;
                const lineNumbers = [];
                
                for (let line = startLine; line <= endLine; line++) {
                    lineNumbers.push(line);
                }
                
                lines.push({ contract, lines: lineNumbers });
            }
            
            vuln.lines = lines;
            return vuln;
        })
        .filter(vuln => vuln.lines && vuln.lines.length > 0);
}
